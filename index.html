<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Face Recognition</title>
<style>
  :root { color-scheme: light dark; }
  body {
    margin: 0;
    font-family: system-ui, Arial;
    min-height: 100vh;
    display: grid;
    place-items: center;
    background: #111;
    color: #fff;
    padding: 16px;
  }
  .wrap {
    width: min(900px, 100%);
    display: grid;
    gap: 12px;
    justify-items: center;
  }
  h1 {
    margin: 0;
    font-size: clamp(20px, 3vw, 28px);
  }
  #startBtn {
    padding: 12px 18px;
    border-radius: 10px;
    border: 0;
    background: #2ecc71;
    color: #000;
    font-weight: 600;
    cursor: pointer;
  }
  .stage {
    position: relative;
    width: 100%;
    aspect-ratio: 4/3;
    max-height: 70vh;
    display: none;
  }
  video, canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 12px;
  }
  #nameOverlay {
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    padding: 6px 14px;
    background: rgba(0,0,0,0.6);
    border-radius: 8px;
    font-size: 20px;
    font-weight: bold;
    display: none;
  }
  .hint {
    font-size: 13px;
    opacity: .8;
    text-align: center;
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Face Recognition</h1>
    <p class="hint">Click start → allow camera. Works on mobile and laptop. Includes voice feedback.</p>
    <button id="startBtn">Start Camera & Recognition</button>
    <div class="stage" id="stage">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
      <div id="nameOverlay"></div>
    </div>
    <div class="hint">If iPhone: allow Camera in Settings → Safari → Camera if prompted.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script>
    const startBtn = document.getElementById('startBtn');
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const stage = document.getElementById('stage');
    const nameOverlay = document.getElementById('nameOverlay');

    let lastDisplayed = "";
    let lastSpoken = "";
    let lastSpokenTime = 0;
    let speechUnlocked = false;

    // ✅ Unlock speech on first button click
    function unlockSpeech() {
      if (!speechUnlocked && 'speechSynthesis' in window) {
        speechUnlocked = true;
        const dummy = new SpeechSynthesisUtterance("Ready");
        dummy.volume = 0.01; // almost silent
        window.speechSynthesis.speak(dummy);
      }
    }

    function speakName(name) {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(name);
        window.speechSynthesis.speak(utter);
      }
    }

    async function loadModels() {
      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri('preprocess/models'),
        faceapi.nets.faceLandmark68Net.loadFromUri('preprocess/models'),
        faceapi.nets.faceRecognitionNet.loadFromUri('preprocess/models')
      ]);
    }

    async function loadDescriptors() {
      const res = await fetch('preprocess/descriptors.json', { cache: 'no-store' });
      const data = await res.json();
      return data.map(p =>
        new faceapi.LabeledFaceDescriptors(
          p.label,
          p.descriptors.map(d => new Float32Array(d))
        )
      );
    }

    async function getCameraStream() {
      try {
        // Try back camera first (mobile ke liye best)
        return await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: "environment" } }
        });
      } catch (err) {
        console.warn("Back camera not available, switching to front:", err);
        // Fallback to front camera (laptop & iPhone case)
        return await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" }
        });
      }
    }

    async function start() {
      unlockSpeech(); // ✅ Enable speech right at the start button click

      startBtn.disabled = true;
      startBtn.textContent = 'Loading models...';
      await loadModels();

      startBtn.textContent = 'Loading dataset...';
      const labeled = await loadDescriptors();
      const matcher = new faceapi.FaceMatcher(labeled, 0.5);

      startBtn.textContent = 'Requesting camera...';
      const stream = await getCameraStream();   // ✅ yahan use ho raha hai
      video.srcObject = stream;
      await new Promise(r => video.onloadedmetadata = r);

      startBtn.style.display = 'none';
      stage.style.display = 'block';

      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;
      const ctx = overlay.getContext('2d');
      const size = { width: overlay.width, height: overlay.height };
      faceapi.matchDimensions(overlay, size);

      async function tick() {
        const detections = await faceapi
          .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
          .withFaceLandmarks()
          .withFaceDescriptors();

        ctx.clearRect(0, 0, overlay.width, overlay.height);
        const resized = faceapi.resizeResults(detections, size);

        let currentName = "Unknown";
        if (resized.length > 0) {
          const best = matcher.findBestMatch(resized[0].descriptor);
          if (best.distance < 0.45) currentName = best.label;
        }

        if (currentName !== lastDisplayed) {
          nameOverlay.style.display = "block";
          nameOverlay.textContent = currentName;
          lastDisplayed = currentName;

          const now = Date.now();
          if (
            currentName !== "Unknown" &&
            (currentName !== lastSpoken || now - lastSpokenTime > 3000)
          ) {
            speakName(currentName);
            lastSpoken = currentName;
            lastSpokenTime = now;
          }
        }

        resized.forEach((d) => {
          const box = d.detection.box;
          ctx.strokeStyle = "lime";
          ctx.lineWidth = 3;
          ctx.strokeRect(box.x, box.y, box.width, box.height);
        });

        requestAnimationFrame(tick);
      }
      tick();
    }


    startBtn.addEventListener('click', start);
  </script>
</body>
</html>
